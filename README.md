# java-operator-samples
Source code with exemples of Kubernetes operators developed with the Java language

## ğŸ‰ Init project
 - la branche `01-init-project` contient le rÃ©sultat de cette Ã©tape
 - [installer / mettre](https://sdk.operatorframework.io/docs/installation/) Ã  jour la derniÃ¨re version du [Operator SDK](https://sdk.operatorframework.io/) (v1.22.2 au moment de l'Ã©criture du readme)
 - crÃ©er le rÃ©pertoire `java-operator-samples `
 - dans le rÃ©pertoire `java-operator-samples `, scaffolding du projet avec Quarkus : `operator-sdk init --plugins quarkus --domain wilda.fr --project-name java-operator-samples`
 - l'arborescence gÃ©nÃ©rÃ©e est la suivante:
```bash
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ Makefile
â”œâ”€â”€ PROJECT
â”œâ”€â”€ README.md
â”œâ”€â”€ pom.xml
â”œâ”€â”€ src
â”‚   â””â”€â”€ main
â”‚       â”œâ”€â”€ java
â”‚       â””â”€â”€ resources
â”‚           â””â”€â”€ application.properties
```
 - âš ï¸ Au moment de l'Ã©criture de ce tuto il est nÃ©cessaire de changer manuellement les versions de Quarkus et du SDK dans le `pom.xml`:
    - passer la propriÃ©tÃ© `quarkus.version` Ã  `2.11.2.Final`
    - passer la propriÃ©tÃ© `quarkus-sdk.version` Ã  `4.0.0`
 - Supprimer la dÃ©pendance `quarkus-operator-sdk-csv-generator` qui n'est plus dans le bom
 - vÃ©rification que cela compile : `mvn clean compile`
 - tester le lancement: `mvn quarkus:dev`:
```bash
__  ____  __  _____   ___  __ ____  ______ 
 --/ __ \/ / / / _ | / _ \/ //_/ / / / __/ 
 -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\ \   
--\___\_\____/_/ |_/_/|_/_/|_|\____/___/   
2022-08-26 17:36:38,732 WARN  [io.qua.config] (Quarkus Main Thread) Unrecognized configuration key "quarkus.operator-sdk.generate-csv" was provided; it will be ignored; verify that the dependency extension for this configuration is set or that you did not make a typo

2022-08-26 17:36:38,968 WARN  [io.fab.kub.cli.Config] (Quarkus Main Thread) Found multiple Kubernetes config files [[/Users/sphilipp/dev/ovh/k8s/kubeconfig-example2.yml, /Users/sphilipp/dev/ovh/k8s/big-k8s.yml]], using the first one: [/Users/sphilipp/dev/ovh/k8s/kubeconfig-example2.yml]. If not desired file, please change it by doing `export KUBECONFIG=/path/to/kubeconfig` on Unix systems or `$Env:KUBECONFIG=/path/to/kubeconfig` on Windows.
2022-08-26 17:36:39,041 WARN  [io.fab.kub.cli.Config] (Quarkus Main Thread) Found multiple Kubernetes config files [[/Users/sphilipp/dev/ovh/k8s/kubeconfig-example2.yml, /Users/sphilipp/dev/ovh/k8s/big-k8s.yml]], using the first one: [/Users/sphilipp/dev/ovh/k8s/kubeconfig-example2.yml]. If not desired file, please change it by doing `export KUBECONFIG=/path/to/kubeconfig` on Unix systems or `$Env:KUBECONFIG=/path/to/kubeconfig` on Windows.
2022-08-26 17:36:39,160 INFO  [io.qua.ope.run.OperatorProducer] (Quarkus Main Thread) Quarkus Java Operator SDK extension 4.0.0 (commit: abfa719 on branch: abfa71954a61b9fab0c7561bff68d85c3037f369) built on Sun Aug 14 22:20:17 CEST 2022
2022-08-26 17:36:39,162 WARN  [io.qua.ope.run.AppEventListener] (Quarkus Main Thread) No Reconciler implementation was found so the Operator was not started.
2022-08-26 17:36:39,216 INFO  [io.quarkus] (Quarkus Main Thread) java-operator-samples 0.0.1-SNAPSHOT on JVM (powered by Quarkus 2.11.2.Final) started in 2.257s. Listening on: http://localhost:8080
2022-08-26 17:36:39,217 INFO  [io.quarkus] (Quarkus Main Thread) Profile dev activated. Live Coding activated.
2022-08-26 17:36:39,217 INFO  [io.quarkus] (Quarkus Main Thread) Installed features: [cdi, kubernetes, kubernetes-client, micrometer, openshift-client, operator-sdk, smallrye-context-propagation, smallrye-health, vertx]
```

## ğŸ“„ CRD generation
 - la branche `02-crd-generation` contient le rÃ©sultat de cette Ã©tape
 - crÃ©ation de l'API : `operator-sdk create api --version v1 --kind ReleaseDetector`
 - cette commande a crÃ©Ã© les 4 classes nÃ©cessaires pour crÃ©er l'opÃ©rateur:
```bash
src
â””â”€â”€ main
    â”œâ”€â”€ java
    â”‚   â””â”€â”€ fr
    â”‚       â””â”€â”€ wilda
    â”‚           â”œâ”€â”€ ReleaseDetector.java
    â”‚           â”œâ”€â”€ ReleaseDetectorReconciler.java
    â”‚           â”œâ”€â”€ ReleaseDetectorSpec.java
    â”‚           â””â”€â”€ ReleaseDetectorStatus.java
```
  - tester que tout compile que la CRD se gÃ©nÃ¨re bien: `mvn clean package` (ou restez en mode `mvn quarkus:dev` pour voir la magie opÃ©rer en direct :wink:)
  - la CRD doit Ãªtre gÃ©nÃ©rÃ©e dans le target, `target/kubernetes/releasedetectors.wilda.fr-v1.yml`:
```yaml
# Generated by Fabric8 CRDGenerator, manual edits might get overwritten!
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: releasedetectors.wilda.fr
spec:
  group: wilda.fr
  names:
    kind: ReleaseDetector
    plural: releasedetectors
    singular: releasedetector
  scope: Namespaced
  versions:
  - name: v1
    schema:
      openAPIV3Schema:
        properties:
          spec:
            type: object
          status:
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
```
  - elle doit aussi Ãªtre installÃ©e sur le cluster:
```bash
$ kubectl get crds releasedetectors.wilda.fr
NAME                        CREATED AT

releasedetectors.wilda.fr   2022-08-26T15:40:19Z
```

## ğŸ“  CRD auto apply
 - la branche `03-auto-apply-crd` contient le rÃ©sultat de cette Ã©tape
 - ajouter un champ `name` dans `ReleaseDetectorSpec.java`:
```java
public class ReleaseDetectorSpec {
    private String name;

    public void setName(String name) {
        this.name = name;
    }

    public String getName() {
        return name;
    }
}
```
  - vÃ©rifier que la CRD a bien Ã©tÃ© mise Ã  jour:
```bash
$ kubectl get crds releasedetectors.wilda.fr -o json | jq '.spec.versions[0].schema.openAPIV3Schema.properties.spec'

{
  "properties": {
    "name": {
      "type": "string"
    }
  },
  "type": "object"
}
```
 - modifier le reconciler `ReleaseDetectorReconciler.java`:
```java
public class ReleaseDetectorReconciler
    implements Reconciler<ReleaseDetector>, Cleaner<ReleaseDetector> {
  private static final Logger log = LoggerFactory.getLogger(ReleaseDetectorReconciler.class);
  private final KubernetesClient client;

  public ReleaseDetectorReconciler(KubernetesClient client) {
    this.client = client;
  }

  @Override
  public UpdateControl<ReleaseDetector> reconcile(ReleaseDetector resource, Context context) {
    log.info("ğŸ‘‹ Hello, World ğŸŒ ! From {} ", resource.getSpec().getName());

    return UpdateControl.noUpdate();
  }

  @Override
  public DeleteControl cleanup(ReleaseDetector resource, Context<ReleaseDetector> context) {
    log.info("ğŸ¥²  Goodbye, World ğŸŒ ! From {}", resource.getSpec().getName());

    return DeleteControl.defaultDelete();
  }
}    
```
  - crÃ©er le namespace `test-hello-world-operator`: `kubectl create ns test-hello-world-operator`
  - crÃ©er la CR `src/test/resources/cr-test-hello-world.yaml` pour tester:
```yaml
apiVersion: "wilda.fr/v1"
kind: ReleaseDetector
metadata:
  name: hello-world
spec:
  name: the Moon ğŸŒ• !
```
  - crÃ©er la CR dans Kubernetes : `kubectl apply -f ./src/test/resources/cr-test-hello-world.yaml -n test-hello-world-operator`
  - la sortie de l'opÃ©rateur devrait afficher le message `INFO  [fr.wil.ReleaseDetectorReconciler] (EventHandler-releasedetectorreconciler) ğŸ‘‹ Hello, World ğŸŒ ! From the Moon ğŸŒ• ! `
  - supprimer la CR : `kubectl delete releasedetectors.wilda.fr hello-world -n test-hello-world-operator`
  - la sortie de l'opÃ©rateur devrait afficher le message `INFO  [fr.wil.ReleaseDetectorReconciler] (EventHandler-releasedetectorreconciler) ğŸ¥²  Goodbye, World ğŸŒ ! From the Moon ğŸŒ• !`
